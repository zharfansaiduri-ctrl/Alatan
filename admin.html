<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="img/UHSB-Logo-resize.png">    
    <title>Admin Portal - Kehadiran</title>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script src="js/auth.js"></script>
    <script>
    if (sessionStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = "adminlogin.html";
    }
    </script>
    <script src="js/logopdf.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'League Spartan', sans-serif;
            background: linear-gradient(135deg, #1A2350 0%, #1FA2FF 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: #F4F6F8;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #1A2350;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #4A4A4A;
            font-size: 16px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid transparent;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tab.active {
            background: #F4F6F8;
            color: #1A2350;
            border-color: #12D8FA;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .qr-card {
            background: #F4F6F8;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .qr-card h3 {
            color: #1A2350;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .qr-card .details {
            color: #4A4A4A;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .qr-code-container {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            display: inline-block;
        }

        .download-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #1FA2FF 0%, #12D8FA 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'League Spartan', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(31, 162, 255, 0.3);
        }

        .attendance-section {
            background: #F4F6F8;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-bar select, .filter-bar input {
            padding: 12px 20px;
            border: 2px solid #a0a0a0;
            border-radius: 10px;
            font-family: 'League Spartan', sans-serif;
            font-size: 16px;
            background: white;
            flex: 1;
            min-width: 200px;
        }

        .filter-bar select:focus, .filter-bar input:focus {
            outline: none;
            border-color: #1FA2FF;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            color: #1FA2FF;
            font-size: 32px;
            font-weight: 700;
        }

        .stat-label {
            color: #4A4A4A;
            font-size: 14px;
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: flex-end;
        }

        .pdf-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'League Spartan', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #1A2350;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4A4A4A;
            font-size: 18px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #a0a0a0;
            font-size: 16px;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: #1FA2FF;
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'League Spartan', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #12D8FA;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .qr-grid {
                grid-template-columns: 1fr;
            }

            .filter-bar {
                flex-direction: column;
            }

            .filter-bar select, .filter-bar input {
                width: 100%;
            }

            .action-buttons {
                flex-direction: column;
            }

            .pdf-btn, .refresh-btn {
                width: 100%;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Admin Portal Sistem Kehadiran</h1>
            <p class="subtitle">Dicipta oleh UPSI Holdings Sdn. Bhd.</p>
            <button class="refresh-btn" style="float:right;" onclick="logout()">Log Keluar</button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('qr')">Jana QR Code</div>
            <div class="tab" onclick="switchTab('attendance')">Lihat Kehadiran</div>
        </div>

        <div id="qrSection" class="content-section active">
            <div style="margin-bottom: 20px; text-align: right;">
                <button class="refresh-btn" onclick="loadSessionData()" style="margin-left: 0;">
                    ðŸ”„ Muat Semula QR Code
                </button>
            </div>
            <div class="qr-grid" id="qrGrid">
                <div style="grid-column: 1/-1; text-align: center; color: white; padding: 40px;">
                    Memuatkan data sesi...
                </div>
            </div>
        </div>

        <div id="attendanceSection" class="content-section">
            <div class="attendance-section">
                <div class="filter-bar">
                    <select id="sesiFilter" onchange="filterAttendance()">
                        <option value="">Semua Sesi</option>
                    </select>
                    <input type="text" id="searchInput" placeholder="Cari nama atau jabatan..." onkeyup="filterAttendance()">
                    <button class="refresh-btn" onclick="loadAttendanceData()">Muat Semula</button>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalAttendees">0</div>
                        <div class="stat-label">Jumlah Kehadiran</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="upsiCount">0</div>
                        <div class="stat-label">UPSI</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="aswaraCount">0</div>
                        <div class="stat-label">ASWARA</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="pdf-btn" onclick="downloadPDF()">
                        <span>ðŸ“„</span>
                        Muat Turun PDF
                    </button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama</th>
                                <th>Jabatan</th>
                                <th>Trainer/Trainee</th>
                                <th>Sesi</th>
                                <th>Modul</th>
                                <th>Tarikh & Masa</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTable">
                            <tr>
                                <td colspan="7" class="loading">Memuatkan data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = "adminlogin.html";
        }
        let sessionData = {};
        let allAttendanceData = {};
        let currentFilteredData = [];
        
        const SESSION_API = 'https://script.google.com/macros/s/AKfycbwAcZuDryEzXB8ZpaGY88DMCOv9LzO7jhA4MXqNcwT0H809DXlVSz2AroZ-veYAkju2/exec';
        const BASE_URL = 'https://ict-upsiholdings.github.io/sistemkehadiranuhsbmysisaswara/index.html';
        const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxYHxFRZJxODIaOTB64KWYteK2w7Ncc8d5dOHSbsgJYZLaEAA48oo0h7ttd5J1pEi5l/exec';

        async function loadSessionData() {
            try {
                console.log('Fetching session data from:', SESSION_API);
                const response = await fetch(SESSION_API, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Session data loaded:', data);
                
                if (!data || Object.keys(data).length === 0) {
                    throw new Error('Tiada data sesi diterima dari pelayan');
                }
                
                sessionData = data;
                generateQRCodes();
            } catch (error) {
                console.error('Error loading session data:', error);
                let errorMsg = error.message;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'Tidak dapat menghubungi pelayan. Semak sambungan internet atau URL API.';
                } else if (error.message.includes('CORS')) {
                    errorMsg = 'Masalah CORS. API perlu dikonfigurasi untuk membenarkan akses.';
                }
                
                document.getElementById('qrGrid').innerHTML = `
                    <div style="grid-column: 1/-1;">
                        <div class="error-message">
                            <strong>Ralat memuatkan data sesi:</strong><br>
                            ${errorMsg}<br><br>
                            <strong>URL API:</strong> ${SESSION_API}<br><br>
                            <button class="refresh-btn" onclick="loadSessionData()">Cuba Lagi</button>
                        </div>
                    </div>
                `;
            }
        }

        function populateSesiFilter() {
            const sesiFilter = document.getElementById('sesiFilter');
            sesiFilter.innerHTML = '<option value="">Semua Sesi</option>';
            
            Object.keys(allAttendanceData).forEach(sheetName => {
                const option = document.createElement('option');
                option.value = sheetName;
                option.textContent = sheetName;
                sesiFilter.appendChild(option);
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            
            if (tab === 'qr') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('qrSection').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('attendanceSection').classList.add('active');
                if (Object.keys(allAttendanceData).length === 0) {
                    loadAttendanceData();
                }
            }
        }

        function generateQRCodes() {
            // const BASE_URL = "https://ict-upsiholdings.github.io/sistemkehadiranuhsb/";
            const grid = document.getElementById('qrGrid');
            grid.innerHTML = '';

            // Jika tiada data sesi
            if (!sessionData || Object.keys(sessionData).length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: white; padding: 40px;">
                        Tiada data sesi tersedia.
                    </div>
                `;
                return;
            }

            // Tukar sessionData jadi array dan loop ikut index
            const keys = Object.keys(sessionData);
            keys.forEach((key, index) => {
                const data = sessionData[key];
                const sesiNumber = index + 1; // ðŸ‘ˆ mula dari 1
                const url = `${BASE_URL}?url=${sesiNumber}`;

                const card = document.createElement('div');
                card.className = 'qr-card';
                card.innerHTML = `
                    <h3>Sesi ${sesiNumber}</h3>
                    <div class="details">
                        <strong>${data.modul || '-'}</strong><br>
                        ${data.tarikhMasa || '-'}
                    </div>
                    <div class="qr-code-container" id="qr${sesiNumber}"></div>
                    <button class="download-btn" onclick="downloadQR('qr${sesiNumber}', 'QR_Sesi_${sesiNumber}')">
                        Muat Turun QR Code
                    </button>
                `;
                grid.appendChild(card);

                // Jana QR selepas card dimasukkan
                setTimeout(() => {
                    new QRCode(document.getElementById(`qr${sesiNumber}`), {
                        text: url,
                        width: 200,
                        height: 200,
                        colorDark: "#1A2350",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }, 100);
            });
        }

        function downloadQR(elementId, filename) {
            const canvas = document.querySelector(`#${elementId} canvas`);
            if (!canvas) {
                alert('QR code belum siap. Sila cuba lagi.');
                return;
            }
            const url = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `${filename}.png`;
            link.href = url;
            link.click();
        }

        async function loadAttendanceData() {
            const tbody = document.getElementById('attendanceTable');
            tbody.innerHTML = '<tr><td colspan="7" class="loading">Memuatkan data...</td></tr>';
            
            try {
                console.log('Fetching attendance data from:', API_ENDPOINT);
                const response = await fetch(`${API_ENDPOINT}?action=getAttendance`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Attendance data loaded:', data);
                
                allAttendanceData = data;
                populateSesiFilter();
                
                const flattenedData = flattenAttendanceData(allAttendanceData);
                currentFilteredData = flattenedData;
                displayAttendanceData(flattenedData);
                updateStats(flattenedData);
            } catch (error) {
                console.error('Error loading attendance:', error);
                let errorMsg = error.message;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'Tidak dapat menghubungi pelayan. Semak sambungan internet atau URL API.';
                } else if (error.message.includes('CORS')) {
                    errorMsg = 'Masalah CORS. API perlu dikonfigurasi untuk membenarkan akses.';
                }
                
                tbody.innerHTML = `
                    <tr><td colspan="7">
                        <div class="error-message">
                            <strong>Ralat memuatkan data:</strong><br>
                            ${errorMsg}<br><br>
                            <strong>URL API:</strong> ${API_ENDPOINT}?action=getAttendance<br><br>
                            <button class="refresh-btn" onclick="loadAttendanceData()">Cuba Lagi</button>
                        </div>
                    </td></tr>
                `;
            }
        }
        
        function flattenAttendanceData(data) {
            let flattened = [];
            Object.keys(data).forEach(sheetName => {
                if (Array.isArray(data[sheetName])) {
                    flattened = flattened.concat(data[sheetName]);
                }
            });
            return flattened;
        }

        function displayAttendanceData(data) {
            const tbody = document.getElementById('attendanceTable');
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="7" class="no-data">Tiada rekod kehadiran.</td></tr>
                `;
                return;
            }

            // Format tarikh & masa jika wujud
            tbody.innerHTML = data.map((record, index) => {
            // Format tarikh & masa jika wujud
            let timestamp = '-';
            if (record['Timestamp']) {
                const date = new Date(record['Timestamp']);
                timestamp = date.toLocaleString('ms-MY', {
                    timeZone: 'Asia/Kuala_Lumpur',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                }).replace(',', ''); // buang koma selepas tarikh
            }

            return `
                <tr>
                    <td>${index + 1}</td>
                    <td>${record.Nama || '-'}</td>
                    <td>${record.Jabatan || '-'}</td>
                    <td>${record['Trainer/Trainee'] || '-'}</td>
                    <td>${record['Tarikh & Masa'] || '-'}</td>
                    <td>${record.Modul || '-'}</td>
                    <td>${timestamp}</td>
                </tr>
            `;
        }).join('');
        }

        function updateStats(data) {
            document.getElementById('totalAttendees').textContent = data.length;
            document.getElementById('upsiCount').textContent = 
                data.filter(r => r['Trainer/Trainee'] === 'UPSI').length;
            document.getElementById('aswaraCount').textContent = 
                data.filter(r => r['Trainer/Trainee'] === 'ASWARA').length;
        }

        function filterAttendance() {
            const sesiFilter = document.getElementById('sesiFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = [];

            if (sesiFilter) {
                if (allAttendanceData[sesiFilter] && Array.isArray(allAttendanceData[sesiFilter])) {
                    filtered = [...allAttendanceData[sesiFilter]];
                }
            } else {
                filtered = flattenAttendanceData(allAttendanceData);
            }

            if (searchTerm) {
                filtered = filtered.filter(r => 
                    (r.Nama && r.Nama.toLowerCase().includes(searchTerm)) ||
                    (r.Jabatan && r.Jabatan.toLowerCase().includes(searchTerm))
                );
            }

            currentFilteredData = filtered;
            displayAttendanceData(filtered);
            updateStats(filtered);
        }

       async function downloadPDF() {
    if (currentFilteredData.length === 0) {
        alert('Tiada data untuk dimuat turun.');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // === ðŸ§© Header: 1 gambar penuh (banner/logo gabungan) ===
const headerImage = logosBase64.header; // ambil dari logopdf.js

async function addHeaderImage(doc, src, x, y, maxWidth) {
  try {
    let imgData;
    if (src.startsWith('data:image')) {
      imgData = src;
    } else {
      const response = await fetch(src);
      const blob = await response.blob();
      const reader = new FileReader();
      imgData = await new Promise((resolve) => {
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    // Dapatkan saiz sebenar â†’ maintain aspect ratio
    const props = doc.getImageProperties(imgData);
    const ratio = props.width / props.height;
    const h = maxWidth / ratio;

    doc.addImage(imgData, 'PNG', x, y, maxWidth, h);
    return h; // supaya boleh kira Y seterusnya bawah gambar
  } catch (e) {
    console.warn('Gagal tambah header:', e);
    return 0;
  }
}

// Tambah header di atas
const headerHeight = await addHeaderImage(doc, headerImage, 14, 10, 180);



    // === ðŸ§¾ Tajuk & info laporan ===
    const textStartY = 45; // letak bawah logo
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('Laporan Kehadiran Sistem Pengurusan Kehadiran UHSB', 14, textStartY);

    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    doc.text('Kehadiran User Acceptance Test (UAT) MySIS@ASWARA', 14, textStartY + 8);

    // Tarikh semasa
    const currentDate = new Date().toLocaleString('ms-MY', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    doc.setFontSize(9);
    doc.text(`Dijana pada: ${currentDate}`, 14, textStartY + 16);

    // === ðŸ“‹ Info penapis (filter) ===
    const sesiFilter = document.getElementById('sesiFilter').value;
    const searchTerm = document.getElementById('searchInput').value;
    let yPos = textStartY + 25;

    if (sesiFilter) {
        // Extract nombor sesi dari "Sesi 1" â†’ 1
        const sesiNumber = parseInt(sesiFilter.replace('Sesi ', ''));
        
        // sessionData adalah array, index bermula dari 0
        // Jadi Sesi 1 = index 0, Sesi 2 = index 1, dst
        const sesiData = sessionData[sesiNumber - 1];
        
        console.log('sesiNumber:', sesiNumber);
        console.log('sesiData:', sesiData);
        
        doc.text(`Sesi: ${sesiFilter}`, 14, yPos);
        yPos += 5;
        
        if (sesiData) {
            if (sesiData.modul) {
                doc.text(`Modul: ${sesiData.modul}`, 14, yPos);
                yPos += 5;
            }
            if (sesiData.tarikhMasa) {
                doc.text(`Tarikh & Masa: ${sesiData.tarikhMasa}`, 14, yPos);
                yPos += 5;
            }
        }
    }
    if (searchTerm) {
        doc.text(`Carian: ${searchTerm}`, 14, yPos);
        yPos += 5;
    }

    // === ðŸ“Š Statistik ===
    yPos += 3;
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('Statistik:', 14, yPos);
    doc.setFont(undefined, 'normal');
    yPos += 6;
    doc.text(`Jumlah Kehadiran: ${currentFilteredData.length}`, 14, yPos);
    yPos += 5;
    doc.text(`UPSI: ${currentFilteredData.filter(r => r['Trainer/Trainee'] === 'UPSI').length}`, 14, yPos);
    yPos += 5;
    doc.text(`ASWARA: ${currentFilteredData.filter(r => r['Trainer/Trainee'] === 'ASWARA').length}`, 14, yPos);

    // === ðŸ“‘ Sediakan jadual ===

    // Tentukan columns based on filter
    let tableHeaders, tableData;

    if (sesiFilter) {
        // Kalau ada filter sesi - buang column Sesi & Modul
        tableHeaders = [['No.', 'Nama', 'Jabatan', 'Trainer/Trainee', 'Tarikh & Masa']];
        
        tableData = currentFilteredData.map((record, index) => {
            let timestamp = '-';
            if (record['Timestamp']) {
                const date = new Date(record['Timestamp']);
                timestamp = date.toLocaleString('ms-MY', {
                    timeZone: 'Asia/Kuala_Lumpur',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                }).replace(',', '');
            }

            return [
                index + 1,
                record.Nama || '-',
                record.Jabatan || '-',
                record['Trainer/Trainee'] || '-',
                timestamp
            ];
        });
    } else {
        // Kalau semua sesi - tunjuk semua columns
        tableHeaders = [['No.', 'Nama', 'Jabatan', 'Trainer/Trainee', 'Sesi', 'Modul', 'Tarikh & Masa']];
        
        tableData = currentFilteredData.map((record, index) => {
            let timestamp = '-';
            if (record['Timestamp']) {
                const date = new Date(record['Timestamp']);
                timestamp = date.toLocaleString('ms-MY', {
                    timeZone: 'Asia/Kuala_Lumpur',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                }).replace(',', '');
            }

            return [
                index + 1,
                record.Nama || '-',
                record.Jabatan || '-',
                record['Trainer/Trainee'] || '-',
                record['Tarikh & Masa'] || '-',
                record.Modul || '-',
                timestamp
            ];
        });
    }

    doc.autoTable({
        startY: yPos + 8,
        head: tableHeaders,
        body: tableData,
        theme: 'striped',
        headStyles: {
            fillColor: [26, 35, 80],
            textColor: 255,
            fontStyle: 'bold',
            fontSize: 9
        },
        bodyStyles: {
            fontSize: 8
        },
        alternateRowStyles: {
            fillColor: [245, 245, 245]
        },
        margin: { top: 10, left: 14, right: 14 },
        styles: {
            cellPadding: 3,
            overflow: 'linebreak',
            fontSize: 8
        },
        columnStyles: sesiFilter ? {
            // Filter sesi - 5 columns
            0: { cellWidth: 10 },
            1: { cellWidth: 40 },
            2: { cellWidth: 40 },
            3: { cellWidth: 30 },
            4: { cellWidth: 40 }
        } : {
            // Semua sesi - 7 columns
            0: { cellWidth: 10 },
            1: { cellWidth: 30 },
            2: { cellWidth: 30 },
            3: { cellWidth: 25 },
            4: { cellWidth: 20 },
            5: { cellWidth: 35 },
            6: { cellWidth: 32 }
        },
        didDrawPage: (data) => {
            const pageSize = doc.internal.pageSize;
            const pageWidth = pageSize.getWidth();
            const pageHeight = pageSize.getHeight();

            doc.setFontSize(8);
            doc.text(currentDate, pageWidth - 60, 10);
        }
    });

    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(9);
        doc.text(
            `Halaman ${i} / ${totalPages}`,
            doc.internal.pageSize.getWidth() / 2,
            doc.internal.pageSize.getHeight() - 8,
            { align: 'center' }
        );
    }
    // === ðŸ’¾ Simpan fail ===
    const filename = sesiFilter 
        ? `Kehadiran_${sesiFilter}_${new Date().getTime()}.pdf`
        : `Kehadiran_Semua_${new Date().getTime()}.pdf`;
    doc.save(filename);
}

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadSessionData();
        });

        function logout() {
            sessionStorage.clear();
            window.location.href = "adminlogin.html";
        }
    </script>
</body>
</html>
